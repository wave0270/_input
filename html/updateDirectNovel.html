<!DOCTYPE html>
<html>
<head>
	<meta charset='utf-8'>
	<link rel="stylesheet" type="text/css" href="../../libs/bootstrap/css/bootstrap.min.css" />
	
    <script src="../../libs/jquery/jquery.min.js"></script>
    <script src="../../libs/bootstrap/js/bootstrap.min.js"></script>
    <script src="../../libs/ractive/ractive.min.js"></script>
    <script src="../../custom/js/custom.js"></script>
    <!--local-->
    <script src="../js/extractor.js"></script>
    <script src="../js/custom.js"></script>
    <script src="../../_connector/fileManager.js"></script>
    <!--data-->
    <style>
    	body{
    		padding: 5px;
    	}
    	.input-group {
    		margin: 5px 0;
    	}
    	.input-group-addon:first-of-type{
    		min-width:150px;
    	}
    </style>
</head>
<body>
	<div id="get-comic"> </div>
	<div>
		<div class="input-group">
	      <span class="input-group-addon">Name</span>
	      <input type="text" class="form-control" id="name" placeholder="Đấu phá thương khung" value="Đấu phá thương khung">
	      <span class="input-group-addon">*</span>
	    </div>
	    <div class="input-group">
	      <span class="input-group-addon">Author</span>
	      <input type="text" class="form-control" id="author" placeholder="Thiên Tằm Thổ Đậu" value="Thiên Tằm Thổ Đậu">
	    </div>
	    <div class="input-group">
	      <span class="input-group-addon">Novel Type</span>
	      <input type="text" class="form-control" id="novelType" placeholder="Tình hiệp" value="Tình hiệp">
	    </div>
	    <div class="input-group">
	      <span class="input-group-addon">Status</span>
	      <input type="text" class="form-control" id="status" placeholder="full">
	    </div>
	    <div class="input-group">
	      <span class="input-group-addon">Languages</span>
	      <input type="text" class="form-control" id="languages" placeholder="vietnamese" value="vietnamese">
	    </div>
	    <div class="input-group">
	      <span class="input-group-addon">Folder</span>
	      <input type="text" class="form-control" id="save" placeholder="dau-pha-thuong-khung" value="dau-pha-thuong-khung">
	      <span class="input-group-addon">*</span>
	    </div>
	    <div class="input-group">
	      <span class="input-group-addon">Chapter In Page</span>
	      <input type="text" class="form-control" id="chapterInPage" placeholder="50" value="50">
	    </div>
	    <div class="input-group">
	      <span class="input-group-addon">Page Number</span>
	      <input type="text" class="form-control" id="pageNumber" placeholder="2" value="2">
	      <span class="input-group-addon">*</span>
	    </div>
	    
	    <button type="button" class="btn btn-danger" onclick="start()">Get Data</button>
	</div>
</body>
	<script>
		function extractData(htmlStr,extractor){
			var dataArr = null;
			/*xoa script*/
			while (htmlStr.indexOf("<script") > 0) {
				var temp = htmlStr.slice(htmlStr.indexOf("<script"), htmlStr.indexOf("<\/script>") + 9);
				htmlStr = htmlStr.replace(temp, " ");
			}
			htmlStr = Extractor.disableSrcHref(htmlStr);
			var dataArr = {};
			for(var k in extractor){
				dataArr[extractor[k].name] = Extractor.extractDataFromHtmlString(htmlStr,extractor[k]);
			}
			return dataArr;
		}
		/**
		 * excute some exception
		 **/
		function preData(data,domain){
			if(domain == 'truyen.hixx.info'){
				data = data.slice(5,data.length);
				return data;
			}
		}
		function groupData(data){
			/*find longest array*/
			var longestArr = [];
			for(var k in data){
				if(data[k].length > longestArr.length){
					longestArr = data[k];
				}
			}
			/*group Data*/
			var groupData = [];
			for(var k in data){
				for(var i=0; i<longestArr.length ; i++){
					if(!groupData[i]){
						var item = {};
						groupData.push(item);
					}
					groupData[i][k] = data[k][i];
				}
			}
			return groupData;
		}
		/**
		 * get all page links
		 * **/
		function getPageLink(pageUrl,i){
			var page = {
			    "pageLinks": [],
			    "errorPage": []
			};
			var htmlStr = getRemoteUrl(String.format(pageUrl,i),false);
			if(!htmlStr){
				if(page.errorPage == null){page.errorPage = [];}
				page.errorPage.push({level : 1 , url : dataExtractor.url});
			}else{
				var pageLinks = extractData(htmlStr,dataExtractor.link);
				pageLinks= preData(pageLinks['link'],'truyen.hixx.info');
				page.pageLinks = pageLinks;
				// if(!info.meta.lastPage){info.meta.lastPage = {};}
				// info.meta.lastPage['url'] = dataExtractor.url;
				// info.meta.lastPage['pageNumber'] = i;
			}
			return page;
		}
		/**
		 * get content of only one page
		 * **/
		function getContent(url,novelData){
			var htmlStr = getRemoteUrl(url,false);
			info.meta.chapterNumber++;
			if( htmlStr != '' && htmlStr != null ){
				var pageData = extractData(htmlStr,dataExtractor.content);
				pageData = groupData(pageData);
				if(novelData.data == null){novelData.data = {};}
				pageData[0]["url"] = url;
				pageData[0]["chapter"] = info.meta.chapterNumber;
				novelData.data["chapter-" + info.meta.chapterNumber] = pageData[0];
				indexArr.push({"chapter":info.meta.chapterNumber, "title" : pageData[0]["title"]});
			}else{
				errorPage.push({level : 2, url : url});
				novelData.data.push(null);
			}
			return novelData;
		}
		/**
		 * get content of all pages
		 * **/
		function getContentAll(page){
			var index = 0;
			var length = page.pageLinks.length;
			var statusNumber = 0;
			console.log('Page Number : '+length);
			for(var i=0 ; i < length ; i++){
				novelData = getContent(page.pageLinks[i],novelData,statusNumber);
				statusNumber++;
				/*save a file if i == 50*/
				if( statusNumber == 50 || i==length-1){ 
					index += 50;
					writeFile(novelData,String.format('{0}/{1}/data/{2}-{3}.js',info.meta.type,info.meta.save,'data',index));
					novelData.data = null;
					statusNumber = 0;
				}	
			}
		}
		function start(){
			typeO = 'novels';
			folderO = 'dau-pha-thuong-khung';
			
			info = JSON.parse(fM.read(String.format("{0}/{1}/info.js",typeO,folderO)).data);
			console.log(info)
			dataExtractor = JSON.parse(fM.read(String.format("{0}/{1}/dataExtractor.js",typeO,folderO)).data);
			
			//case: last file have 50 chapter
			var ceilNumber = Math.ceil(info.meta.chapterNumber/50);
			if ( info.meta.chapterNumber/50 == ceilNumber){
				info.meta.chapterNumber++;
				info.meta.lastPage.pageNumber++;
				novelData = {
				    "data": [],
				    "errorPage": []
				};
			}else{
				var fileIndex = Math.ceil(info.meta.chapterNumber/50)*50;
				novelData = JSON.parse(fM.read(String.format("{0}/{1}/data/data-{2}.js",typeO,folderO,fileIndex)).data);
			}
			console.log(novelData)
			
			var page = getPageLink(info.meta.lastPage.url,info.meta.lastPage.pageNumber);
			if(novelData.data.length == null){
				//todo: getcontent all
			}else{
				var tempPage = page;
				for(var k in novelData.data){
					for(var j=0; j < page.data.length ; j++){
						if(novelData.data[k].url == page.data[j]){
							
						}
					}
				}
			}
			console.log(page)
			// var tData = JSON.parse(fM.read("novels/dau-pha-thuong-khung/data/data-50.js").data);
			// var tInfo = JSON.parse(fM.read("novels/dau-pha-thuong-khung/info.js").data);
			// console.log(tData)
			// console.log(info)
		}
		/****************************/
		//1:get empty data:
		
		
		
		

		

	</script>
</html>